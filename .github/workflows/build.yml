name: CI/CD WordPress Deploy to AWS CodeDeploy

on:
  push:
    branches: [ main, staging ]

env:
  AWS_REGION: us-east-1
  S3_BUCKET_NAME: s3-colin-gitact
  CD_APP_NAME: vinte-pruebabelmonte # Tu nombre de la aplicaciÃ³n CodeDeploy
  
jobs:
  # ----------------------------------------------------
  # JOB 1: VALIDACIÃ“N (Se ejecuta siempre que haya un push) ok
  # ----------------------------------------------------
  validate:
    name: Validate PHP Syntax
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ›  Install ZIP utility
        run: |
          sudo apt-get update
          sudo apt-get install -y zip
      # -------------------------------

  # ----------------------------------------------------
  # JOB 2: DESPLIEGUE (Depende de que 'validate' sea exitoso)
  # ----------------------------------------------------
  deploy:
    name: Deploy to ${{ github.ref_name == 'staging' && 'STAGING' || 'PRODUCTION' }}
    needs: validate # Depende del job de validaciÃ³n
    runs-on: ubuntu-latest
    
    # Define variables de ambiente especÃ­ficas del ambiente
    env:
      DEPLOYMENT_GROUP: ${{ github.ref_name == 'staging' && 'Stage-Deployment-Group' || 'Prod-Deployment-Group' }}
      S3_KEY_PREFIX: ${{ github.ref_name == 'staging' && 'staging' || 'production' }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      # 1. AutenticaciÃ³n con AWS (Usando Secrets)
      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 2. Empaquetar y Excluir Archivos Innecesarios
      - name: ğŸ“¦ Create deployment package
        id: package
        run: |
          PACKAGE_NAME="${{ env.S3_KEY_PREFIX }}/deployment-${{ github.sha }}.zip"
          
          # Zip, excluyendo archivos de control de versiones y cachÃ©
          zip -r deployment.zip . \
            -x "*.git*" \
            -x "node_modules/*" \
            -x ".github/*" \
            -x "*.md"
            
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Package created"

      # 3. Subir a S3
      - name: â˜ï¸ Upload to S3
        run: |
          aws s3 cp deployment.zip s3://${{ env.S3_BUCKET_NAME }}/${{ steps.package.outputs.PACKAGE_NAME }}
          echo "âœ… Upload completed"

      # 4. Iniciar Despliegue con CodeDeploy
      - name: ğŸš€ Deploy with CodeDeploy
        id: deploy
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.CD_APP_NAME }} \
            --deployment-group-name ${{ env.DEPLOYMENT_GROUP }} \
            --deployment-config-name CodeDeployDefault.OneAtATime \
            --s3-location bucket=${{ env.S3_BUCKET_NAME }},key=${{ steps.package.outputs.PACKAGE_NAME }},bundleType=zip \
            --description "${{ env.DEPLOYMENT_GROUP }} deployment for commit ${{ github.sha }}" \
            --file-exists-behavior OVERWRITE \
            --query 'deploymentId' \
            --output text)
            
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployment created: $DEPLOYMENT_ID"

      # 5. Esperar a que CodeDeploy finalice (Wait-Action)
      - name: â³ Wait for deployment success
        run: |
          aws deploy wait deployment-successful \
            --deployment-id ${{ steps.deploy.outputs.deployment_id }}
          echo "ğŸ‰ Deployment ${{ steps.deploy.outputs.deployment_id }} successful!"
