name: CI/CD WordPress Deploy to AWS CodeDeploy

on:
  push:
    branches: [ main, staging ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1 # Tu regiÃ³n
  S3_BUCKET_NAME: s3-colin-gitact # Tu nombre del bucket de artefactos
  CD_APP_NAME: vinte-pruebabelmonte # Tu nombre de la aplicaciÃ³n CodeDeploy
  
jobs:
  # ----------------------------------------------------
  # 1. VALIDACIÃ“N (Comprueba que el cÃ³digo PHP es vÃ¡lido)
  # ----------------------------------------------------
  validate:
    name: Validate PHP Syntax
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Setup PHP
        # Esta acciÃ³n es necesaria para que el comando 'php' estÃ© disponible
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1' # Usa la versiÃ³n de PHP de tu servidor
      
      - name: ðŸ”Ž Check PHP Syntax Errors
         # Busca recursivamente archivos .php y verifica su sintaxis
        run: find . -type f -name "*.php" -print0 | xargs -0 -n1 php -l

  # ----------------------------------------------------
  # 2. DESPLIEGUE (Sube y llama a CodeDeploy)
  # ----------------------------------------------------
  deploy:
    name: Deploy to ${{ github.ref_name == 'staging' && 'STAGING' || 'PRODUCTION' }}
    needs: validate
    runs-on: ubuntu-latest
    
    # Variables de ambiente especÃ­ficas para el job
    env:
      DEPLOYMENT_GROUP: ${{ github.ref_name == 'staging' && 'Stage-Deployment-Group' || 'Prod-Deployment-Group' }}
      S3_KEY_PREFIX: ${{ github.ref_name == 'staging' && 'staging' || 'production' }}

      # --- Credenciales de Base de Datos (Mapeo condicional desde Secrets) ---
      # Si la rama es 'staging', usa los secrets STAG; si es 'main', usa PROD.
      DB_NAME: ${{ github.ref_name == 'staging' && secrets.DB_STAG_NAME || secrets.DB_PROD_NAME }}
      DB_HOST: ${{ github.ref_name == 'staging' && secrets.DB_STAG_HOST || secrets.DB_PROD_HOST }}
      DB_USER: ${{ github.ref_name == 'staging' && secrets.DB_STAG_USER || secrets.DB_PROD_USER }}
      DB_PASSWORD: ${{ github.ref_name == 'staging' && secrets.DB_STAG_PASS || secrets.DB_PROD_PASS }}
    
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      # 1. AutenticaciÃ³n con AWS
      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 2. Inyectar secretos de BD en un archivo temporal DENTRO DE LA CARPETA WORDPRESS
      - name: ðŸ”’ Inject DB Credentials into Deployment Package
    # Creamos el archivo DENTRO de la carpeta 'wordpress/' para que CodeDeploy lo recoja.
        run: |
           mkdir -p wordpress # Asegura que la carpeta existe
           CREDENTIALS_FILE="wordpress/.db_credentials" # Define la ruta DENTRO de 'wordpress/'
           # ðŸš¨ CORRECCIÃ“N CLAVE: Usamos $CREDENTIALS_FILE en cada lÃ­nea de 'echo'
           echo "DB_NAME=${{ env.DB_NAME }}" >> $CREDENTIALS_FILE
           echo "DB_HOST=${{ env.DB_HOST }}" >> $CREDENTIALS_FILE
           echo "DB_USER=${{ env.DB_USER }}" >> $CREDENTIALS_FILE
           echo "DB_PASS=${{ env.DB_PASS }}" >> $CREDENTIALS_FILE
      
           echo "Injected credentials into $CREDENTIALS_FILE."
      
  # 3. Empaquetar y Excluir (Corregido para error 127)
      - name: ðŸ“¦ Create deployment package
        id: package
        run: |
          PACKAGE_NAME="${{ env.S3_KEY_PREFIX }}/deployment-${{ github.sha }}.zip"
          
          # COMANDO ZIP EN UNA SOLA LÃNEA LÃ“GICA
          zip -r deployment.zip . -x '*.git*' -x 'node_modules/*' -x '.github/*' -x '*.md'
          
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Package created"

      # 4. Subir a S3
      - name: â˜ï¸ Upload to S3
        run: |
          aws s3 cp deployment.zip s3://${{ env.S3_BUCKET_NAME }}/${{ steps.package.outputs.PACKAGE_NAME }}
          echo "âœ… Upload completed"

      # 5. Iniciar Despliegue con CodeDeploy (Espera la finalizaciÃ³n)
      - name: ðŸš€ Initiate CodeDeploy Deployment and Wait
        id: deploy
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.CD_APP_NAME }} \
            --deployment-group-name ${{ env.DEPLOYMENT_GROUP }} \
            --deployment-config-name CodeDeployDefault.OneAtATime \
            --s3-location bucket=${{ env.S3_BUCKET_NAME }},key=${{ steps.package.outputs.PACKAGE_NAME }},bundleType=zip \
            --description "Deployment for commit ${{ github.sha }}" \
            --query 'deploymentId' \
            --output text)
            
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployment created: $DEPLOYMENT_ID"

          # Espera a que el despliegue finalice (esto mantiene el workflow abierto)
          aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID
          echo "ðŸŽ‰ Deployment successful!"
