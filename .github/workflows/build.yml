name: CI/CD WordPress Deploy to AWS CodeDeploy

on:
  push:
    branches: [ main, staging ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1 # Tu regiÃ³n
  S3_BUCKET_NAME: s3-colin-gitact # Tu nombre del bucket de artefactos
  CD_APP_NAME: vinte-pruebabelmonte # Tu nombre de la aplicaciÃ³n CodeDeploy
  
jobs:
  # ----------------------------------------------------
  # 1. VALIDACIÃ“N (Comprueba que el cÃ³digo PHP es vÃ¡lido)
  # ----------------------------------------------------
  validate:
    name: Validate PHP Syntax
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Check PHP syntax
        # Ejecuta el chequeo de sintaxis; si hay errores, el job falla.
        run: |
          find . -name "*.php" -exec php -l {} \; | grep -v "No syntax errors"
          echo "âœ… Validation completed"

  # ----------------------------------------------------
  # 2. DESPLIEGUE (Sube y llama a CodeDeploy)
  # ----------------------------------------------------
  deploy:
    name: Deploy to ${{ github.ref_name == 'staging' && 'STAGING' || 'PRODUCTION' }}
    needs: validate
    runs-on: ubuntu-latest
    
    # Variables de ambiente especÃ­ficas para el job
    env:
      DEPLOYMENT_GROUP: ${{ github.ref_name == 'staging' && 'Stage-Deployment-Group' || 'Prod-Deployment-Group' }}
      S3_KEY_PREFIX: ${{ github.ref_name == 'staging' && 'staging' || 'production' }}
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      # ðŸ›  Instalar la utilidad ZIP (USANDO YUM/DNF para Amazon Linux)
      - name: ðŸ›  Install ZIP utility
        run: sudo yum update -y && sudo yum install -y zip
        
      # 1. AutenticaciÃ³n con AWS
      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 2. Empaquetar y Excluir (Corregido para error 127)
      - name: ðŸ“¦ Create deployment package
        id: package
        run: |
          PACKAGE_NAME="${{ env.S3_KEY_PREFIX }}/deployment-${{ github.sha }}.zip"
          
          # COMANDO ZIP EN UNA SOLA LÃNEA LÃ“GICA
          zip -r deployment.zip . -x '*.git*' -x 'node_modules/*' -x '.github/*' -x '*.md'
          
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Package created"

      # 3. Subir a S3
      - name: â˜ï¸ Upload to S3
        run: |
          aws s3 cp deployment.zip s3://${{ env.S3_BUCKET_NAME }}/${{ steps.package.outputs.PACKAGE_NAME }}
          echo "âœ… Upload completed"

      # 4. Iniciar Despliegue con CodeDeploy (Espera la finalizaciÃ³n)
      - name: ðŸš€ Initiate CodeDeploy Deployment and Wait
        id: deploy
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.CD_APP_NAME }} \
            --deployment-group-name ${{ env.DEPLOYMENT_GROUP }} \
            --deployment-config-name CodeDeployDefault.OneAtATime \
            --s3-location bucket=${{ env.S3_BUCKET_NAME }},key=${{ steps.package.outputs.PACKAGE_NAME }},bundleType=zip \
            --description "Deployment for commit ${{ github.sha }}" \
            --query 'deploymentId' \
            --output text)
            
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployment created: $DEPLOYMENT_ID"

          # Espera a que el despliegue finalice (esto mantiene el workflow abierto)
          aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID
          echo "ðŸŽ‰ Deployment successful!"
